<!DOCTYPE html>
<html>
<head>
    <title>Dashboard</title>
    <link rel="stylesheet" href="style2.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<header class="topo">
    <div class="topo-container">
        <div class="logo-area" onclick="window.location.href='index.html'" style="cursor:pointer;">
    <img src="Logo_oficial_CCB.png" alt="Logo CCB">
    <span>CCB Itaquiti</span>
</div>

        <h1>Controle de Presen√ßa da RDJ</h1>

       <nav class="menu">
    <button id="darkBtn" onclick="toggleDark()">üåô</button>
    <a href="index.html">Home</a>

    <span id="menuRegistro"></span>

    <a href="historico.html">Hist√≥rico</a>
    <a href="dashboard.html">Dashboard</a>

    <span id="menuLogin"></span>
</nav>
    </div>
</header>

<div class="container">

    <h2>Evolu√ß√£o de Presen√ßa</h2>

    <div class="stats">
        <div class="card-stat">
            <h3>Total de Reuni√µes</h3>
            <p id="totalReunioes">0</p>
        </div>

        <div class="card-stat">
            <h3>M√©dia de Presen√ßa</h3>
            <p id="mediaPresenca">0</p>
        </div>

        <div class="card-stat">
            <h3>Maior Reuni√£o</h3>
            <p id="maiorReuniao">0</p>
        </div>
    </div>

    <div style="margin-bottom:20px;">
        <button onclick="gerarPDFSemana()">PDF da Semana</button>
        <button onclick="gerarPDFMes()">PDF do M√™s</button>
    </div>

    <canvas id="grafico"></canvas>

    <h2 style="margin-top:40px;">Irm√£os x Visitas</h2>
    <canvas id="grafico2"></canvas>

</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script>
  const firebaseConfig = {
     apiKey: "AIzaSyD_QowpgX19PlVE1Cz0D0cpIJh7K0nUq0o",
  authDomain: "ccb-registro.firebaseapp.com",
  projectId: "ccb-registro",
  storageBucket: "ccb-registro.firebasestorage.app",
  messagingSenderId: "634223347098",
  appId: "1:634223347098:web:c5124dd418b601baa22623",
  measurementId: "G-5F7P9SDRBB"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
</script>

<script>

/* =========================
   CONTROLE DE MENU / LOGIN
========================= */

const logado = localStorage.getItem("logado") === "true";
const menuRegistro = document.getElementById("menuRegistro");
const menuLogin = document.getElementById("menuLogin");

if (logado) {
    menuRegistro.innerHTML = '<a href="registro.html">Registrar</a>';
    menuLogin.innerHTML = '<button onclick="sair()">Sair</button>';
} else {
    menuLogin.innerHTML = '<a href="login.html">Login</a>';
}

function sair() {
    localStorage.removeItem("logado");
    window.location.href = "login.html";
}


/* =========================
   DADOS
========================= */

let registros = [];

db.collection("registros")
.orderBy("data")
.onSnapshot((snapshot) => {

    registros = [];

    snapshot.forEach(doc => {
        registros.push(doc.data());
    });

    carregarDashboard();
});

/* =========================
   ESTAT√çSTICAS
========================= */

function carregarDashboard() {

    let datas = [];
    let totais = [];
    let totaisIrmaos = [];
    let totaisVisitas = [];

    registros.forEach(r => {

        const mocos = Number(r.mocos) || 0;
        const mocas = Number(r.mocas) || 0;
        const casados = Number(r.casados) || 0;
        const visitas = Number(r.visitas) || 0;

        const total = mocos + mocas + casados + visitas;

        datas.push(r.data);
        totais.push(total);
        totaisIrmaos.push(mocos + mocas + casados);
        totaisVisitas.push(visitas);
    });

    let somaTotal = totais.reduce((acc, val) => acc + val, 0);
    let maior = Math.max(...totais, 0);
    let media = totais.length ? (somaTotal / totais.length).toFixed(1) : 0;

    document.getElementById("totalReunioes").innerText = registros.length;
    document.getElementById("mediaPresenca").innerText = media;
    document.getElementById("maiorReuniao").innerText = maior;

    new Chart(document.getElementById('grafico'), {
        type: 'line',
        data: {
            labels: datas,
            datasets: [{
                label: 'Total de Presen√ßa',
                data: totais,
                borderWidth: 3,
                tension: 0.3
            }]
        },
        options: { responsive: true }
    });

    new Chart(document.getElementById('grafico2'), {
        type: 'bar',
        data: {
            labels: datas,
            datasets: [
                { label: 'Irm√£os', data: totaisIrmaos },
                { label: 'Visitas', data: totaisVisitas }
            ]
        },
        options: { responsive: true }
    });
}

/* =========================
   PDF
========================= */

function gerarPDFSemana() {

    let hoje = new Date();
    let seteDiasAtras = new Date();
    seteDiasAtras.setDate(hoje.getDate() - 7);

    let filtrados = registros.filter(r => {
        let data = new Date(r.data);
        return data >= seteDiasAtras && data <= hoje;
    });

    criarPDF(filtrados, "Relatorio_Semanal");
}

function gerarPDFMes() {

    let hoje = new Date();
    let mesAtual = hoje.getMonth();
    let anoAtual = hoje.getFullYear();

    let filtrados = registros.filter(r => {
        let data = new Date(r.data);
        return data.getMonth() === mesAtual && data.getFullYear() === anoAtual;
    });

    criarPDF(filtrados, "Relatorio_Mensal");
}

function criarPDF(lista, nomeArquivo) {

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    doc.setFontSize(16);
    doc.text("CCB Itaquiti - Controle de Presen√ßa", 20, 20);

    doc.setFontSize(12);

    if (!lista.length) {
        doc.text("Nenhum registro encontrado no per√≠odo.", 20, 40);
    } else {

        let y = 40;
        let somaTotal = 0;

        lista.forEach(r => {

            const mocos = Number(r.mocos) || 0;
            const mocas = Number(r.mocas) || 0;
            const casados = Number(r.casados) || 0;
            const visitas = Number(r.visitas) || 0;

            const total = mocos + mocas + casados + visitas;
            somaTotal += total;

            doc.text(
                `${r.data} | Palavra: ${r.palavra || "-"} | Total: ${total}`,
                20,
                y
            );

            y += 10;

            if (y > 270) {
                doc.addPage();
                y = 20;
            }
        });

        y += 10;
        doc.text("Total Geral do Per√≠odo: " + somaTotal, 20, y);
    }

    doc.save(nomeArquivo + ".pdf");
}

</script>
<script src="js/global.js"></script>

</body>
</html>